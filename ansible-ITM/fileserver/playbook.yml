- name: Install and configure Samba
  hosts: "{{ var_hosts_fileserver }}"
  become: true

  # TODO: Pass username and password with Terraform
  vars:
    samba_users:
      - name: smbuser
        password: "smbuser"

  tasks:
    # Create shared directory for Samba
    - name: Create shared directory for Samba
      ansible.builtin.file:
        path: /srv/samba/shared
        state: directory
        mode: '0770'
        owner: nobody
        group: nogroup

    # Install Samba package
    - name: Install Samba
      ansible.builtin.apt:
        update_cache: true
        name: samba
        state: present

    # Disable samba-ad-dc service
    - name: Disable samba-ad-dc
      ansible.builtin.systemd:
        name: samba-ad-dc
        enabled: false
        state: stopped

    # Configure smb.conf with a template
    - name: Configure smb.conf
      ansible.builtin.template:
        src: smb.conf.j2
        dest: /etc/samba/smb.conf
      notify:
        - Restart smbd

    # Ensure Samba service is enabled and started
    - name: Enable and start smbd service
      ansible.builtin.service:
        name: smbd
        state: started
        enabled: true

    # Create system user and set password for Samba
    - name: Create system user for Samba
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /sbin/nologin
        state: present
      with_items: "{{ samba_users }}"

    - name: Add Samba user and set password
      ansible.builtin.shell: |
        echo -e "{{ item.password }}\n{{ item.password }}" | smbpasswd -a -s {{ item.name }}
      with_items: "{{ samba_users }}"
      args:
        executable: /bin/bash

  handlers:
    - name: Restart smbd
      ansible.builtin.service:
        name: smbd
        state: restarted
